<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android é¡µé¢ç»˜åˆ¶å…¨æ™¯è§£æ - AOSP æºç çº§</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            fontFamily: 'Arial, sans-serif',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                boxMargin: 10,
                boxTextMargin: 5,
                messageMargin: 10
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(120deg, #1e3c72, #2a5298);
            color: white;
            padding: 40px 60px;
            text-align: center;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-top: 10px;
        }

        .meta {
            background: #f8f9fa;
            padding: 15px 60px;
            border-bottom: 3px solid #667eea;
            font-size: 1.1rem;
        }

        .meta strong {
            color: #667eea;
        }

        .content {
            padding: 40px 60px;
        }

        section {
            margin-bottom: 50px;
            padding: 30px;
            background: #fafafa;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        h3 {
            color: #3498db;
            font-size: 1.5rem;
            margin: 25px 0 15px 0;
        }

        p {
            margin: 15px 0;
            font-size: 1.05rem;
        }

        .highlight {
            background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .warning {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            border-left: 5px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        th {
            background: linear-gradient(120deg, #1e3c72, #2a5298);
            color: white;
            font-weight: 600;
            padding: 15px;
            text-align: left;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #e3f2fd;
        }

        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin: 30px 0;
            text-align: center;
            overflow: auto;
        }

        .source-code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            margin: 20px 0;
            overflow-x: auto;
        }

        .source-code .comment {
            color: #75715e;
        }

        .source-code .keyword {
            color: #f92672;
        }

        .source-code .function {
            color: #66d9ef;
        }

        .source-code .string {
            color: #e6db74;
        }

        .source-code .type {
            color: #a6e22e;
        }

        .diagram-title {
            text-align: center;
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0 10px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .legend {
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .key-point {
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 25px 0;
            border-left: 5px solid #667eea;
        }

        .key-point h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        footer {
            text-align: center;
            padding: 30px;
            background: #2c3e50;
            color: white;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {

            .content,
            .meta,
            header {
                padding: 25px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.6rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“± Android é¡µé¢ç»˜åˆ¶å…¨æ™¯è§£æ</h1>
            <p class="subtitle">AOSP æºç çº§ - ç±»å…³ç³»ã€äº‹ä»¶æµè½¬ä¸æ ¸å¿ƒæœºåˆ¶</p>
        </header>

        <div class="meta">
            <p><strong>æ–‡æ¡£ç‰ˆæœ¬ï¼š</strong>åŸºäº AOSP Android 13 (android-13.0.0_r81)</p>
            <p><strong>æ ¸å¿ƒä¸»é¢˜ï¼š</strong>Activity â†’ Window â†’ DecorView â†’ ViewRootImpl â†’ Surface â†’ BufferQueue â†’
                SurfaceFlinger å®Œæ•´é“¾è·¯</p>
            <p><strong>å…³é”®æœºåˆ¶ï¼š</strong>è„åŒºåŸŸæ£€æµ‹ã€VSync è°ƒåº¦ã€Buffer Holdingã€Triple Bufferingã€é™æ€ç•Œé¢æŒç»­æ˜¾ç¤ºåŸç†</p>
        </div>

        <div class="content">
            <section>
                <h2>ğŸ¯ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆ</h2>

                <div class="key-point">
                    <h4>1. é™æ€ç•Œé¢æŒç»­æ˜¾ç¤ºåŸç†</h4>
                    <p><span class="highlight">Buffer Holding æœºåˆ¶</span>ï¼šSurfaceFlinger æŒæœ‰å·²åˆæˆçš„ bufferï¼Œæ¯å¸§é‡å¤ä½¿ç”¨åŒä¸€å¸§æ•°æ®ã€‚æ— æ–°å¸§ â‰ 
                        æ— æ˜¾ç¤ºï¼Œç»˜åˆ¶ï¼ˆç”Ÿäº§ï¼‰ä¸æ˜¾ç¤ºï¼ˆæ¶ˆè´¹ï¼‰å®Œå…¨è§£è€¦ã€‚</p>
                </div>

                <div class="key-point">
                    <h4>2. VSync æŒ‰éœ€åˆ†å‘</h4>
                    <p><span class="highlight">è„åŒºåŸŸé©±åŠ¨</span>ï¼šä»…å½“çª—å£æœ‰è„åŒºåŸŸï¼ˆç”¨æˆ·äº¤äº’/åŠ¨ç”»/å±æ€§å˜æ›´ï¼‰æ—¶ï¼ŒEventThread æ‰åˆ†å‘ VSync ä¿¡å·ã€‚é™æ€ç•Œé¢æ— è„åŒºåŸŸ â†’
                        ä¸åˆ†å‘ â†’ åº”ç”¨é›¶ç»˜åˆ¶ï¼ˆçœç”µ 90%+ï¼‰ã€‚</p>
                </div>

                <div class="key-point">
                    <h4>3. BufferQueue è·¨è¿›ç¨‹å…±äº«</h4>
                    <p><span class="highlight">å•ä¸€ BufferQueueCore</span>ï¼šProducerï¼ˆAppï¼‰ä¸ Consumerï¼ˆSurfaceFlingerï¼‰å…±äº«åŒä¸€ä¸ª
                        <code>BufferQueueCore</code> å®ä¾‹ï¼Œé€šè¿‡ Binder ä¼ é€’æŒ‡é’ˆå®ç°é›¶æ‹·è´ã€‚64 ä¸ª slot æ˜¯å…ƒæ•°æ®å®¹å™¨ï¼Œå®é™… buffer æ•°é‡åŠ¨æ€åˆ†é…ï¼ˆ2-3 ä¸ªç”¨äº
                        UIï¼Œ6-8 ä¸ªç”¨äº Cameraï¼‰ã€‚</p>
                </div>
            </section>

            <!-- ======================================== -->
            <!-- å›¾1ï¼šç±»æŒæœ‰å…³ç³»å›¾ -->
            <!-- ======================================== -->
            <section id="diagram1">
                <h2>ğŸ“Š å›¾1ï¼šç±»æŒæœ‰å…³ç³»å›¾ï¼ˆé™æ€ç»“æ„ï¼‰</h2>

                <div class="diagram-title">
                    App è¿›ç¨‹ã€System Serverã€SurfaceFlinger è¿›ç¨‹çš„ç±»æŒæœ‰å…³ç³»
                </div>

                <div class="mermaid">
                    flowchart TD
                    subgraph AppProcess["ğŸ“± App Process (com.example.app)"]
                    direction TB

                    subgraph JavaLayer["Java Framework Layer"]
                    AT["ActivityThread
                    frameworks/base/core/java/android/app/ActivityThread.java"]
                    A["Activity
                    frameworks/base/core/java/android/app/Activity.java"]
                    PW["PhoneWindow
                    frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java"]
                    DV["DecorView
                    frameworks/base/core/java/com/android/internal/policy/DecorView.java"]
                    VRI["ViewRootImpl
                    frameworks/base/core/java/android/view/ViewRootImpl.java"]
                    C["Choreographer
                    frameworks/base/core/java/android/view/Choreographer.java"]
                    WMG["WindowManagerGlobal
                    frameworks/base/core/java/android/view/WindowManagerGlobal.java"]
                    end

                    subgraph NativeLayer["Native Layer (libgui)"]
                    RT["RenderThread
                    frameworks/base/libs/hwui/renderthread/RenderThread.cpp"]
                    S["Surface
                    frameworks/base/core/jni/android_view_Surface.cpp
                    frameworks/native/libs/gui/Surface.cpp"]
                    BQP["BufferQueueProducer
                    frameworks/native/libs/gui/BufferQueueProducer.cpp"]
                    end

                    AT -->|holds| A
                    A -->|mWindow| PW
                    PW -->|mDecor| DV
                    WMG -->|mRoots ArrayList| VRI
                    VRI -->|mView| DV
                    VRI -->|mSurface| S
                    VRI -->|mAttachInfo.mThreadedRenderer| RT
                    VRI -->|mChoreographer| C
                    S -->|mGraphicBufferProducer| BQP
                    RT -->|ANativeWindow| S
                    end

                    subgraph SystemServer["âš™ï¸ System Server Process"]
                    WMS["WindowManagerService
                    frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java"]
                    WS["WindowState
                    frameworks/base/services/core/java/com/android/server/wm/WindowState.java"]
                    end

                    subgraph SFProcess["ğŸ¨ SurfaceFlinger Process"]
                    direction TB

                    SF["SurfaceFlinger
                    frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp"]

                    subgraph LayerMgmt["Layer Management"]
                    L["Layer
                    frameworks/native/services/surfaceflinger/Layer.cpp"]
                    BQC["BufferQueueConsumer
                    frameworks/native/libs/gui/BufferQueueConsumer.cpp"]
                    BQCORE["BufferQueueCore
                    frameworks/native/libs/gui/BufferQueueCore.cpp"]
                    end

                    subgraph Composition["Composition Engine"]
                    CE["CompositionEngine
                    frameworks/native/services/surfaceflinger/CompositionEngine/src/CompositionEngine.cpp"]
                    RE["RenderEngine
                    frameworks/native/services/surfaceflinger/RenderEngine/RenderEngine.cpp"]
                    HWC["HWComposer
                    hardware/interfaces/graphics/composer/"]
                    end

                    SF -->|mDrawingState.layers| L
                    L -->|mConsumer| BQC
                    BQC -->|shared| BQCORE
                    SF -->|mCompositionEngine| CE
                    CE -->|mRenderEngine| RE
                    CE -->|mHWComposer| HWC
                    end

                    %% è·¨è¿›ç¨‹å…³ç³»
                    BQP -.->|shares BufferQueueCore| BQCORE
                    VRI -.->|Binder: IWindowSession| WMS
                    WMS -.->|Binder: ISurfaceComposer| SF
                    L -.->|owns| BQCORE

                    %% æ ·å¼å®šä¹‰
                    classDef appProcess fill:#e1f5fe,stroke:#01579b,stroke-width:2px
                    classDef systemProcess fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                    classDef sfProcess fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
                    classDef shared fill:#fff3e0,stroke:#e65100,stroke-width:2px

                    class AT,A,PW,DV,VRI,C,WMG,RT,S,BQP,JavaLayer,NativeLayer,AppProcess appProcess
                    class WMS,WS,SystemServer systemProcess
                    class SF,L,BQC,BQCORE,CE,RE,HWC,LayerMgmt,Composition,SFProcess sfProcess
                    class BQCORE shared
                </div>

                <h3>ğŸ“‹ å›¾1 å…³é”®è¯´æ˜</h3>

                <h4>1. è¿›ç¨‹éš”ç¦»æ¶æ„</h4>
                <table>
                    <thead>
                        <tr>
                            <th>è¿›ç¨‹</th>
                            <th>æ ¸å¿ƒç»„ä»¶</th>
                            <th>èŒè´£</th>
                            <th>æºç è·¯å¾„</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>App Process</strong></td>
                            <td>Activity/ViewRootImpl/Surface</td>
                            <td>UI ç»˜åˆ¶ï¼ˆç”Ÿäº§è€…ï¼‰</td>
                            <td><code>frameworks/base/</code></td>
                        </tr>
                        <tr>
                            <td><strong>System Server</strong></td>
                            <td>WindowManagerService</td>
                            <td>çª—å£ç®¡ç†åè°ƒ</td>
                            <td><code>frameworks/base/services/core/java/com/android/server/wm/</code></td>
                        </tr>
                        <tr>
                            <td><strong>SurfaceFlinger</strong></td>
                            <td>Layer/CompositionEngine</td>
                            <td>å›¾å½¢åˆæˆï¼ˆæ¶ˆè´¹è€…ï¼‰</td>
                            <td><code>frameworks/native/services/surfaceflinger/</code></td>
                        </tr>
                    </tbody>
                </table>

                <h4>2. æ ¸å¿ƒæŒæœ‰é“¾ï¼ˆæºç è¯æ®ï¼‰</h4>
                <p><strong>WindowManagerGlobal å…¨å±€ç®¡ç†ï¼š</strong></p>
                <div class="source-code">
                    <span class="comment">// frameworks/base/core/java/android/view/WindowManagerGlobal.java</span><br>
                    <span class="keyword">public</span> <span class="keyword">final</span> <span
                        class="keyword">class</span> <span class="type">WindowManagerGlobal</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// å•ä¾‹æ¨¡å¼</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span> <span class="keyword">static</span>
                    WindowManagerGlobal sDefaultWindowManager;<br>
                    <br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// ä¸‰ä¸ªå¹³è¡Œåˆ—è¡¨ï¼šæ‰€æœ‰çª—å£çš„æ ¹å¯¹è±¡</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span> <span class="keyword">final</span>
                    ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> ArrayList&lt;&gt;();<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span> <span class="keyword">final</span>
                    ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="keyword">new</span> ArrayList&lt;&gt;();<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span> <span class="keyword">final</span>
                    ArrayList&lt;WindowManager.LayoutParams&gt; mParams = <span class="keyword">new</span>
                    ArrayList&lt;&gt;();<br>
                    <br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span> <span class="keyword">void</span> <span
                        class="function">addView</span>(View view, ViewGroup.LayoutParams params) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ViewRootImpl root = <span class="keyword">new</span>
                    ViewRootImpl(context, display);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mViews.add(view);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mRoots.add(root); <span class="comment">// â†
                        æ ¸å¿ƒæŒæœ‰å…³ç³»</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mParams.add(wparams);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root.setView(view, wparams, panelParentView);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    }
                </div>

                <p><strong>ViewRootImpl ä¸ DecorView åŒå‘å…³è”ï¼š</strong></p>
                <div class="source-code">
                    <span class="comment">// frameworks/base/core/java/android/view/ViewRootImpl.java</span><br>
                    <span class="keyword">public</span> <span class="keyword">final</span> <span
                        class="keyword">class</span> <span class="type">ViewRootImpl</span> <span
                        class="keyword">implements</span> ViewParent {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// æŒæœ‰ DecorViewï¼ˆæ­£å‘ï¼‰</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">final</span> View mView;<br>
                    <br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span> <span class="keyword">void</span> <span
                        class="function">setView</span>(View view, WindowManager.LayoutParams attrs) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mView = view; <span class="comment">// â† ä¿å­˜
                        DecorView å¼•ç”¨</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view.assignParent(<span
                        class="keyword">this</span>); <span class="comment">// â† DecorView.mParent = this</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    }
                </div>

                <p><strong>BufferQueue è·¨è¿›ç¨‹å…±äº«ï¼ˆå…³é”®ï¼ï¼‰ï¼š</strong></p>
                <div class="source-code">
                    <span class="comment">// frameworks/native/libs/gui/BufferQueueProducer.cpp</span><br>
                    BufferQueueProducer::<span class="function">BufferQueueProducer</span>(<span
                        class="keyword">const</span> sp&lt;BufferQueueCore&gt;& core)<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;: mCore(core) {} <span class="comment">// â† Producer æŒæœ‰ core å¼ºå¼•ç”¨</span><br>
                    <br>
                    <span class="comment">// frameworks/native/libs/gui/BufferQueueConsumer.cpp</span><br>
                    BufferQueueConsumer::<span class="function">BufferQueueConsumer</span>(<span
                        class="keyword">const</span> sp&lt;BufferQueueCore&gt;& core)<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;: mCore(core) {} <span class="comment">// â† Consumer æŒæœ‰ core å¼ºå¼•ç”¨</span><br>
                    <br>
                    <span class="comment">// ä¸¤è€…æŒ‡å‘åŒä¸€å†…å­˜åœ°å€çš„ BufferQueueCoreï¼Œå®ç°é›¶æ‹·è´å…±äº«</span>
                </div>

                <div class="legend">
                    <strong>ğŸ’¡ å…³é”®è®¤çŸ¥ï¼š</strong> BufferQueueProducer ä¸ BufferQueueConsumer <strong>å…±äº«åŒä¸€ä¸ª
                        BufferQueueCore</strong>ï¼Œé€šè¿‡ Binder ä¼ é€’æŒ‡é’ˆå®ç°è·¨è¿›ç¨‹é›¶æ‹·è´ã€‚64 ä¸ª slot æ˜¯å…ƒæ•°æ®å®¹å™¨ï¼ˆ~6.4KBï¼‰ï¼Œå®é™… GraphicBuffer
                    æ˜¯å…±äº«å†…å­˜ï¼ˆ~4MB/ä¸ªï¼‰ã€‚
                </div>
            </section>

            <!-- ======================================== -->
            <!-- å›¾2ï¼šäº‹ä»¶æµè½¬æ—¶åºå›¾ -->
            <!-- ======================================== -->
            <section id="diagram2">
                <h2>ğŸ”„ å›¾2ï¼šäº‹ä»¶æµè½¬æ—¶åºå›¾ï¼ˆVSync é©±åŠ¨çš„å®Œæ•´æµæ°´çº¿ï¼‰</h2>

                <div class="diagram-title">
                    ä» VSync ä¿¡å·åˆ°å±å¹•åˆ·æ–°çš„å®Œæ•´äº‹ä»¶é“¾ï¼ŒåŒ…å«é™æ€ç•Œé¢ç‰¹æ®Šå¤„ç†
                </div>

                <div class="mermaid">
                    sequenceDiagram
                    participant HW as Display Hardware<br />(HW VSync)
                    participant SF as SurfaceFlinger<br />(Native)
                    participant ET as EventThread<br />(Native)
                    participant WMS as WindowManagerService<br />(System Server)
                    participant VRI as ViewRootImpl<br />(App Process)
                    participant RT as RenderThread<br />(App Process)
                    participant GPU as GPU Hardware
                    participant BQ as BufferQueueCore<br />(Shared)

                    Note over HW,SF: é˜¶æ®µ1: VSync ä¿¡å·åˆ†å‘ (t=0ms)
                    HW->>SF: HW VSync (60Hz)
                    SF->>SF: computeDirtyRegion()
                    alt æœ‰è„åŒºåŸŸ (ç”¨æˆ·äº¤äº’/åŠ¨ç”»)
                    SF->>ET: dispatchVsync(dirtyRegion)
                    ET->>VRI: Choreographer#doFrame(frameTimeNanos)
                    else æ— è„åŒºåŸŸ (é™æ€ç•Œé¢)
                    ET-.->VRI: æ— ä¿¡å· (App ä¸ç»˜åˆ¶)
                    SF->>SF: onMessageInvalidate() // SF è‡ªèº«åˆæˆ
                    end

                    Note over VRI,RT: é˜¶æ®µ2: åº”ç”¨ç»˜åˆ¶ (ä»…è„åŒºåŸŸè§¦å‘)
                    VRI->>VRI: performTraversals()
                    VRI->>VRI: measure/layout/draw â†’ DisplayList
                    VRI->>RT: syncAndDrawFrame()
                    RT->>RT: parse DisplayList â†’ GL commands
                    RT->>BQ: dequeueBuffer() // ä» FREE slot è·å– buffer
                    RT->>GPU: submit GL commands (async)
                    GPU->>GPU: rasterize â†’ fill GraphicBuffer
                    GPU->>RT: signal acquireFence (fd)
                    RT->>BQ: queueBuffer(buffer, acquireFence)
                    BQ->>SF: onFrameAvailable() // Binder callback

                    Note over SF,BQ: é˜¶æ®µ3: åˆæˆä¸æ˜¾ç¤º (t=16.67ms)
                    HW->>SF: Next HW VSync
                    SF->>SF: handleRefresh()
                    SF->>BQ: acquireBuffer() // ç­‰å¾… acquireFence
                    BQ-->>SF: buffer + releaseFence
                    SF->>SF: preComposition() // è®¡ç®—å¯è§åŒºåŸŸ
                    alt ç®€å•Layer (ä¸é€æ˜)
                    SF->>HWC: setLayer(buffer, z-order)
                    else å¤æ‚Layer (åŠé€æ˜)
                    SF->>RE: drawLayers() // GPUåˆæˆ
                    RE->>GPU: submit composition commands
                    GPU->>SF: synthesized buffer
                    SF->>HWC: setClientTarget(synthesized buffer)
                    end
                    SF->>HWC: presentDisplay(releaseFence)
                    HWC->>HW: commit to Display Controller
                    HW->>HW: refresh panel (next VSync)

                    Note over SF,BQ: é˜¶æ®µ4: Buffer é‡Šæ”¾ (å¼‚æ­¥)
                    HW->>SF: scanout complete â†’ trigger releaseFence
                    SF->>BQ: releaseBuffer(buffer)
                    BQ->>BQ: slot state: ACQUIRED â†’ FREE
                    BQ-.->RT: å¯é‡ç”¨ (ä¸‹æ¬¡ dequeueBuffer)

                    Note over SF: é™æ€ç•Œé¢ç‰¹æ®Šå¤„ç†
                    Note right of SF: æ— æ–°å¸§æ—¶:<br />- ä¸è°ƒç”¨ releaseBuffer()<br />- æŒæœ‰ buffer é‡å¤åˆæˆ<br />- mActiveBuffer ä¸å˜
                </div>

                <h3>ğŸ“‹ å›¾2 å…³é”®æµè½¬è¯´æ˜</h3>

                <h4>1. VSync åˆ†å‘å†³ç­–ï¼ˆè„åŒºåŸŸæ£€æµ‹ï¼‰</h4>
                <div class="source-code">
                    <span class="comment">// frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp</span><br>
                    Region SurfaceFlinger::<span class="function">computeDirtyRegion</span>(<span
                        class="keyword">const</span> DisplayDevice&amp; display) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;Region dirty;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (<span class="keyword">const</span> <span
                        class="keyword">auto</span>& layer : mDrawingState.layersSortedByZ) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
                    (layer-&gt;isVisible()) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dirty |=
                    layer-&gt;getDirtyRegion(); <span class="comment">// åˆå¹¶æ‰€æœ‰ Layer è„åŒºåŸŸ</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> dirty &amp; display.getBounds();<br>
                    }<br>
                    <br>
                    <span class="comment">//
                        frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp</span><br>
                    <span class="keyword">void</span> EventThread::<span class="function">onHotplugReceived</span>(...)
                    {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;Region dirtyRegion = mFlinger-&gt;computeDirtyRegion(display);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (!dirtyRegion.isEmpty()) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dispatchVsyncToApps(dirtyRegion); <span
                        class="comment">// æœ‰è„åŒºåŸŸ â†’ åˆ†å‘ VSync</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;} <span class="keyword">else</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mFlinger-&gt;onMessageInvalidate(); <span
                        class="comment">// æ— è„åŒºåŸŸ â†’ ä»… SF è‡ªèº«åˆæˆ</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    }
                </div>

                <div class="success">
                    <strong>âœ… é™æ€ç•Œé¢çœç”µåŸç†ï¼š</strong> æ— è„åŒºåŸŸ â†’ ä¸åˆ†å‘ VSync â†’ App é›¶ç»˜åˆ¶ï¼ˆCPU/GPU ä¼‘çœ ï¼‰â†’ ä»… SF åˆæˆæ—§å¸§ï¼ˆ~1-2mWï¼‰ã€‚
                </div>

                <h4>2. Buffer çŠ¶æ€æµè½¬ï¼ˆBufferQueueCore.mSlots[]ï¼‰</h4>
                <div class="source-code">
                    <span class="comment">// frameworks/native/libs/gui/BufferQueueCore.h</span><br>
                    <span class="keyword">namespace</span> android::<span class="type">BufferQueueDefs</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">constexpr</span>
                    <span class="keyword">int</span> NUM_BUFFER_SLOTS = <span class="literal">64</span>; <span
                        class="comment">// å›ºå®š 64 ä¸ª slot</span><br>
                    }<br>
                    <br>
                    <span class="keyword">enum</span> BufferState { FREE, DEQUEUED, QUEUED, ACQUIRED };<br>
                    <br>
                    <span class="keyword">struct</span> BufferSlot {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;sp&lt;GraphicBuffer&gt; mGraphicBuffer; <span class="comment">// æŒ‡å‘å®é™…
                        GraphicBufferï¼ˆå¯èƒ½ä¸º nullï¼‰</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;BufferState mBufferState;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;sp&lt;Fence&gt; mFence;<br>
                    };<br>
                    <br>
                    <span class="comment">// å…¸å‹çŠ¶æ€æµè½¬:</span><br>
                    <span class="comment">// dequeueBuffer(): FREE â†’ DEQUEUED</span><br>
                    <span class="comment">// queueBuffer(): DEQUEUED â†’ QUEUED â†’ è§¦å‘ onFrameAvailable()</span><br>
                    <span class="comment">// acquireBuffer(): QUEUED â†’ ACQUIRED (ç­‰å¾… acquireFence)</span><br>
                    <span class="comment">// releaseBuffer(): ACQUIRED â†’ FREE (é™æ€ç•Œé¢è·³è¿‡æ­¤æ­¥)</span>
                </div>

                <h4>3. é™æ€ç•Œé¢æŒç»­æ˜¾ç¤ºæœºåˆ¶ï¼ˆBuffer Holdingï¼‰</h4>
                <div class="source-code">
                    <span class="comment">// frameworks/native/services/surfaceflinger/Layer.cpp</span><br>
                    sp&lt;GraphicBuffer&gt; Layer::<span class="function">getBuffer</span>() <span
                        class="keyword">const</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> mActiveBuffer; <span class="comment">//
                        â† å§‹ç»ˆè¿”å›å½“å‰æŒæœ‰çš„ buffer</span><br>
                    }<br>
                    <br>
                    <span class="keyword">void</span> Layer::<span class="function">onFrameAvailable</span>(<span
                        class="keyword">const</span> BufferItem&amp; item) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;mActiveBuffer = item.mGraphicBuffer; <span class="comment">// æ–°å¸§åˆ°æ¥ï¼šæ›´æ–° active
                        buffer</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;mDirtyRegion = mVisibleRegion;<br>
                    }<br>
                    <br>
                    <span class="keyword">void</span> Layer::<span class="function">releasePendingBuffers</span>() {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// ä»…å½“ mActiveBuffer å˜æ›´æ—¶æ‰ release</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (mActiveBuffer != mPreviousBuffer) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mConsumer-&gt;releaseBuffer(mPreviousBufferSlot,
                    ...);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mPreviousBuffer = mActiveBuffer;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// æ— æ–°å¸§æ—¶ï¼šmActiveBuffer ä¸å˜ â†’ ä¸è§¦å‘ releaseBuffer() â†’
                        buffer ä¿æŒ ACQUIRED</span><br>
                    }
                </div>

                <div class="warning">
                    <strong>âŒ å¸¸è§è¯¯è§£ï¼š</strong> "æ— ç»˜åˆ¶ = æ— æ˜¾ç¤º" â†’ <strong>é”™è¯¯ï¼</strong>
                    ç»˜åˆ¶ï¼ˆç”Ÿäº§ï¼‰ä¸æ˜¾ç¤ºï¼ˆæ¶ˆè´¹ï¼‰è§£è€¦ï¼šæ— æ–°å¸§æ—¶ï¼Œæ¶ˆè´¹è€…ï¼ˆSurfaceFlingerï¼‰é‡å¤ä½¿ç”¨æ—§å¸§ï¼Œå±å¹•æŒç»­æ˜¾ç¤ºã€‚
                </div>

                <h4>4. Fence åŒæ­¥æ—¶åºï¼ˆç¡¬ä»¶çº§åŒæ­¥ï¼‰</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Fence ç±»å‹</th>
                            <th>äº§ç”Ÿæ–¹</th>
                            <th>ç­‰å¾…æ–¹</th>
                            <th>ä½œç”¨</th>
                            <th>æºç ä½ç½®</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>acquireFence</code></td>
                            <td>GPUï¼ˆæ¸²æŸ“å®Œæˆï¼‰</td>
                            <td>SurfaceFlinger</td>
                            <td>ç¡®ä¿ GPU æ¸²æŸ“å®Œæˆåå†è¯»å– buffer</td>
                            <td><code>RenderThread::queueBuffer()</code></td>
                        </tr>
                        <tr>
                            <td><code>releaseFence</code></td>
                            <td>Display Controllerï¼ˆæ‰«æå®Œæˆï¼‰</td>
                            <td>Appï¼ˆRenderThreadï¼‰</td>
                            <td>ç¡®ä¿ Display è¯»å–å®Œæˆåå†é‡ç”¨ buffer</td>
                            <td><code>HWComposer::presentDisplay()</code></td>
                        </tr>
                    </tbody>
                </table>

                <div class="source-code">
                    <span class="comment">// frameworks/native/libs/gui/BufferQueueProducer.cpp</span><br>
                    status_t BufferQueueProducer::<span class="function">queueBuffer</span>(<span
                        class="keyword">int</span> slot, ...) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;sp&lt;Fence&gt; acquireFence = args.acquireFence;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;mSlots[slot].mAcquireFence = acquireFence; <span class="comment">// ä¿å­˜
                        acquireFence</span><br>
                    }<br>
                    <br>
                    <span class="comment">// frameworks/native/libs/gui/BufferQueueConsumer.cpp</span><br>
                    status_t BufferQueueConsumer::<span class="function">acquireBuffer</span>(...) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;sp&lt;Fence&gt; acquireFence = mSlots[slot].mAcquireFence;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;acquireFence-&gt;wait(...); <span class="comment">// â† é˜»å¡ç­‰å¾… GPU
                        å®Œæˆæ¸²æŸ“</span><br>
                    }
                </div>
            </section>

            <!-- ======================================== -->
            <!-- å›¾3ï¼šBufferQueue è·¨è¿›ç¨‹å…±äº«ç»“æ„å›¾ -->
            <!-- ======================================== -->
            <section id="diagram3">
                <h2>ğŸ”— å›¾3ï¼šBufferQueue è·¨è¿›ç¨‹å…±äº«ç»“æ„å›¾</h2>

                <div class="diagram-title">
                    Producerï¼ˆAppï¼‰ä¸ Consumerï¼ˆSurfaceFlingerï¼‰å¦‚ä½•å…±äº« BufferQueueCore
                </div>

                <div class="mermaid">
                    flowchart LR
                    subgraph AppProducer["ğŸ“± App Process (Producer)"]
                    BQP["BufferQueueProducer<br />IGraphicBufferProducer"]
                    S["Surface<br />ANativeWindow"]
                    RT["RenderThread"]

                    RT -->|dequeue/queueBuffer| S
                    S -->|JNI| BQP
                    end

                    subgraph SharedMem["ğŸ’¾ Shared Memory (Kernel)"]
                    BQCORE["BufferQueueCore<br />mSlots-64-"]

                    subgraph Slot0["Slot 0 (DEQUEUED)"]
                    S0["GraphicBuffer #0<br />ashmem fd=123<br />state=DEQUEUED"]
                    end

                    subgraph Slot1["Slot 1 (QUEUED)"]
                    S1["GraphicBuffer #1<br />ashmem fd=124<br />state=QUEUED"]
                    end

                    subgraph Slot2["Slot 2 (ACQUIRED)"]
                    S2["GraphicBuffer #2<br />ashmem fd=125<br />state=ACQUIRED"]
                    end

                    subgraph SlotRest["Slot 3-63 (FREE/INVALID)"]
                    S3["...<br />mGraphicBuffer=null"]
                    end

                    BQCORE --> S0
                    BQCORE --> S1
                    BQCORE --> S2
                    BQCORE --> S3
                    end

                    subgraph SFConsumer["ğŸ¨ SurfaceFlinger (Consumer)"]
                    BQC["BufferQueueConsumer<br />IGraphicBufferConsumer"]
                    L["Layer"]
                    SF["SurfaceFlinger"]

                    L -->|mConsumer| BQC
                    SF -->|mDrawingState| L
                    BQC -->|acquire/releaseBuffer| BQCORE
                    end

                    BQP -.->|Binderä¼ é€’ core æŒ‡é’ˆ| BQCORE
                    BQC -.->|ç›´æ¥æŒæœ‰ core æŒ‡é’ˆ| BQCORE

                    RT -.->|GPUå¡«å……| S0
                    S0 -.->|mmap| SF
                    S1 -.->|mmap| SF
                    S2 -.->|mmap| SF

                    GPU["GPU Hardware"] -->|acquireFence fd| BQP
                    BQP -->|Binderä¼ é€’ fd| BQC
                    BQC -->|wait| GPU

                    HW["Display Hardware"] -->|releaseFence fd| SF
                    SF -->|Binderä¼ é€’ fd| BQP
                    BQP -->|wait| HW

                    classDef appProcess fill:#e1f5fe,stroke:#01579b,stroke-width:2px
                    classDef sfProcess fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
                    classDef shared fill:#fff3e0,stroke:#e65100,stroke-width:2px

                    class AppProducer,BQP,S,RT appProcess
                    class SFConsumer,BQC,L,SF sfProcess
                    class SharedMem,BQCORE,S0,S1,S2,S3 shared
                </div>

                <h3>ğŸ“‹ å›¾3 å…³é”®è¯´æ˜</h3>

                <h4>1. BufferQueueCore åˆ›å»ºä¸å…±äº«æœºåˆ¶</h4>
                <div class="source-code">
                    <span class="comment">// frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp</span><br>
                    status_t SurfaceFlinger::<span class="function">createLayer</span>(...) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 1. åˆ›å»ºå”¯ä¸€çš„ BufferQueueCoreï¼ˆåœ¨ SurfaceFlinger
                        è¿›ç¨‹ï¼‰</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;sp&lt;BufferQueueCore&gt; core = <span class="keyword">new</span>
                    BufferQueueCore();<br>
                    <br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 2. åˆ›å»º Producer å’Œ Consumerï¼Œå…±äº«åŒä¸€ä¸ª core</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;sp&lt;BufferQueueProducer&gt; producer = <span class="keyword">new</span>
                    BufferQueueProducer(core);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;sp&lt;BufferQueueConsumer&gt; consumer = <span class="keyword">new</span>
                    BufferQueueConsumer(core);<br>
                    <br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 3. åˆ›å»º Layerï¼ŒæŒæœ‰ Consumer</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;sp&lt;Layer&gt; layer = <span class="keyword">new</span> Layer(...,
                    consumer);<br>
                    <br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 4. é€šè¿‡ Binder å°† Producer ä¼ é€’ç»™ Appï¼ˆé™„å¸¦ core
                        æŒ‡é’ˆï¼‰</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;outBufferQueueProducer = IGraphicBufferProducer::asBinder(producer);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> NO_ERROR;<br>
                    }
                </div>

                <div class="success">
                    <strong>âœ… æ ¸å¿ƒæœºåˆ¶ï¼š</strong> <code>BufferQueueCore</code> <strong>ä»…å®ä¾‹åŒ–ä¸€æ¬¡</strong>ï¼ˆç”± SurfaceFlinger
                    åˆ›å»ºï¼‰ï¼Œé€šè¿‡ Binder ä¼ é€’ <code>IGraphicBufferProducer</code> æ¥å£æ—¶ï¼Œ<strong>é™„å¸¦ <code>BufferQueueCore</code>
                        çš„å¼ºå¼•ç”¨æŒ‡é’ˆ</strong>ï¼Œå®ç°è·¨è¿›ç¨‹é›¶æ‹·è´å…±äº«ã€‚
                </div>

                <h4>2. GraphicBuffer é›¶æ‹·è´åŸç†</h4>
                <div class="source-code">
                    <span class="comment">// frameworks/native/libs/ui/GraphicBuffer.cpp</span><br>
                    status_t GraphicBuffer::<span class="function">initSize</span>(...) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;status_t err = GraphicBufferAllocator::get().allocate(..., &handle);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// handle åŒ…å« ashmem fd
                        å’Œç‰©ç†åœ°å€ï¼ˆnative_handle_tï¼‰</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> err;<br>
                    }<br>
                    <br>
                    <span class="comment">// frameworks/native/libs/ui/GraphicBufferAllocator.cpp</span><br>
                    status_t GraphicBufferAllocator::<span class="function">allocate</span>(...) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// é€šè¿‡ Gralloc HAL åˆ†é…å…±äº«å†…å­˜ï¼ˆashmem/IONï¼‰</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;err = mAllocDev-&gt;alloc(..., &handle, &stride);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> err;<br>
                    }
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>èµ„æºç±»å‹</th>
                            <th>å•ä¸ªå¤§å°</th>
                            <th>64 ä¸ªæ€»é‡</th>
                            <th>å®é™…åˆ†é…</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Slot å…ƒæ•°æ®</strong></td>
                            <td>~100 å­—èŠ‚</td>
                            <td><strong>6.4 KB</strong></td>
                            <td>64 ä¸ªï¼ˆé™æ€åˆ†é…ï¼‰</td>
                            <td>BufferSlot ç»“æ„ä½“æ•°ç»„</td>
                        </tr>
                        <tr>
                            <td><strong>GraphicBuffer</strong></td>
                            <td>~4 MB (1080p)</td>
                            <td>256 MB</td>
                            <td>2-3 ä¸ªï¼ˆåŠ¨æ€åˆ†é…ï¼‰</td>
                            <td>ashmem/ION å…±äº«å†…å­˜</td>
                        </tr>
                    </tbody>
                </table>

                <div class="legend">
                    <strong>ğŸ’¡ å†…å­˜æˆæœ¬åˆ†æï¼š</strong> 64 ä¸ª slot ä»… 6.4 KBï¼ˆå¯å¿½ç•¥ï¼‰ï¼Œå®é™… GraphicBuffer æŒ‰éœ€åˆ†é…ï¼ˆ2-3 ä¸ªç”¨äº UIï¼‰ã€‚64
                    æ˜¯å®‰å…¨ä¸Šé™ï¼Œé˜²æ­¢èµ„æºè€—å°½ã€‚
                </div>

                <h4>3. Fence è·¨è¿›ç¨‹ä¼ é€’æœºåˆ¶</h4>
                <div class="source-code">
                    <span class="comment">// frameworks/native/libs/gui/BufferQueueProducer.cpp</span><br>
                    status_t BufferQueueProducer::<span class="function">queueBuffer</span>(<span
                        class="keyword">int</span> slot, ...) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> fenceFd = -<span
                        class="literal">1</span>;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (fence != <span
                        class="keyword">nullptr</span>) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fenceFd = fence-&gt;dup(); <span class="comment">//
                        â† dup() fd ç”¨äºè·¨è¿›ç¨‹ä¼ é€’</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// é€šè¿‡ Binder ä¼ é€’ fenceFdï¼ˆLinux fd å¯è·¨è¿›ç¨‹ä¼ é€’ï¼‰</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;mProducer-&gt;queueBuffer(slot, fenceFd, ...);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> NO_ERROR;<br>
                    }
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>äº¤äº’ç±»å‹</th>
                            <th>ä¼ é€’å†…å®¹</th>
                            <th>æœºåˆ¶</th>
                            <th>æ•°æ®é‡</th>
                            <th>æºç è·¯å¾„</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>å…ƒæ•°æ®</strong></td>
                            <td>slot ID/æ—¶é—´æˆ³/Fence fd</td>
                            <td>Binder IPC</td>
                            <td>~100 å­—èŠ‚/å¸§</td>
                            <td><code>IGraphicBufferProducer.aidl</code></td>
                        </tr>
                        <tr>
                            <td><strong>åƒç´ æ•°æ®</strong></td>
                            <td>GraphicBuffer å†…å®¹</td>
                            <td>ashmem/ION å…±äº«å†…å­˜</td>
                            <td>~4 MB/å¸§ (1080p)</td>
                            <td><code>Gralloc4.cpp</code></td>
                        </tr>
                        <tr>
                            <td><strong>åŒæ­¥ä¿¡å·</strong></td>
                            <td>GPU/Display å®Œæˆäº‹ä»¶</td>
                            <td>Linux Sync Fence (fd)</td>
                            <td>4 å­—èŠ‚ (fd)</td>
                            <td><code>sync/sync.h</code></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- ======================================== -->
            <!-- æ ¸å¿ƒæœºåˆ¶æ€»ç»“ -->
            <!-- ======================================== -->
            <section id="summary">
                <h2>ğŸ† æ ¸å¿ƒæœºåˆ¶æ€»ç»“</h2>

                <h3>1. é™æ€ç•Œé¢æŒç»­æ˜¾ç¤ºçš„çœŸç›¸</h3>
                <table>
                    <thead>
                        <tr>
                            <th>è¯¯è§£</th>
                            <th>æ­£ç¡®æœºåˆ¶</th>
                            <th>æºç è¯æ®</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>"æ— ç»˜åˆ¶=é»‘å±"</td>
                            <td><strong>Buffer Holding</strong>ï¼šSF æŒæœ‰ ACQUIRED buffer é‡å¤åˆæˆ</td>
                            <td><code>Layer::getBuffer()</code> å§‹ç»ˆè¿”å› <code>mActiveBuffer</code></td>
                        </tr>
                        <tr>
                            <td>"æ¯å¸§éœ€æ–° buffer"</td>
                            <td>åˆæˆå¼•æ“æ¥å— <strong>ä»»æ„æœ‰æ•ˆ buffer</strong>ï¼ˆæ–°/æ—§å‡å¯ï¼‰</td>
                            <td><code>CompositionEngine::present()</code> æ— æ–°æ—§æ£€æŸ¥</td>
                        </tr>
                        <tr>
                            <td>"buffer ç”¨å®Œå³é‡Šæ”¾"</td>
                            <td>ä»…å½“ <code>mActiveBuffer</code> å˜æ›´æ—¶æ‰ <code>releaseBuffer()</code></td>
                            <td><code>Layer::releasePendingBuffers()</code> æ¡ä»¶åˆ¤æ–­</td>
                        </tr>
                    </tbody>
                </table>

                <h3>2. è¿›ç¨‹é—´åä½œæœ¬è´¨</h3>
                <table>
                    <thead>
                        <tr>
                            <th>äº¤äº’ç±»å‹</th>
                            <th>ä¼ é€’å†…å®¹</th>
                            <th>æœºåˆ¶</th>
                            <th>æºç è·¯å¾„</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>å…ƒæ•°æ®</strong></td>
                            <td>slot ID/æ—¶é—´æˆ³/Fence fd</td>
                            <td>Binder IPC</td>
                            <td><code>frameworks/native/libs/gui/IGraphicBufferProducer.cpp</code></td>
                        </tr>
                        <tr>
                            <td><strong>åƒç´ æ•°æ®</strong></td>
                            <td>GraphicBuffer å†…å®¹</td>
                            <td>ashmem/ION å…±äº«å†…å­˜</td>
                            <td><code>frameworks/native/libs/ui/GraphicBuffer.cpp</code></td>
                        </tr>
                        <tr>
                            <td><strong>åŒæ­¥ä¿¡å·</strong></td>
                            <td>GPU/Display å®Œæˆäº‹ä»¶</td>
                            <td>Linux Sync Fence (fd)</td>
                            <td><code>system/core/libsync/sync.c</code></td>
                        </tr>
                    </tbody>
                </table>

                <h3>3. ä¸ºä»€ä¹ˆ Camera éœ€è¦ >3 ä¸ª bufferï¼Ÿ</h3>
                <div class="source-code">
                    <span class="comment">// Camera HAL3 Pipeline Depth éœ€æ±‚</span><br>
                    <span class="comment">// ISP å¤„ç†å»¶è¿Ÿ 60-100ms &gt; 30fps å¸§é—´éš” 33ms</span><br>
                    <span class="comment">// å¿…é¡»åŒæ—¶æŒæœ‰å¤šä¸ª request ç»´æŒ pipeline æ»¡è½½</span><br>
                    <br>
                    <span class="comment">// æœ€å° buffer éœ€æ±‚å…¬å¼ï¼š</span><br>
                    min_buffers = ceil(ISP_latency / frame_interval) + <span class="literal">1</span><br>
                    <br>
                    <span class="comment">// 30fps (33ms) + 80ms å»¶è¿Ÿ â†’ ceil(80/33) + 1 = 4 ä¸ª</span><br>
                    <span class="comment">// 60fps (16.67ms) + 80ms å»¶è¿Ÿ â†’ ceil(80/16.67) + 1 = 6 ä¸ª</span>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>åœºæ™¯</th>
                            <th>å…¸å‹ buffer æ•°é‡</th>
                            <th>åŸå› </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>æ™®é€š UI</strong></td>
                            <td>2 â†’ 3ï¼ˆTripleï¼‰</td>
                            <td>åŒç¼“å†²åŸºç¡€ï¼Œå¡é¡¿æ—¶åŠ¨æ€æ‰©å®¹</td>
                        </tr>
                        <tr>
                            <td><strong>Camera Preview</strong></td>
                            <td>4-8 ä¸ª</td>
                            <td>HAL3 pipeline depth è¦æ±‚ï¼ˆå¤šå¸§åœ¨ ISP ä¸­å¹¶è¡Œå¤„ç†ï¼‰</td>
                        </tr>
                        <tr>
                            <td><strong>Video Playback</strong></td>
                            <td>3-5 ä¸ª</td>
                            <td>MediaCodec è¾“å‡ºé˜Ÿåˆ—éœ€é¢„åˆ†é…</td>
                        </tr>
                        <tr>
                            <td><strong>åˆ†å±/å¤šçª—å£</strong></td>
                            <td>6+ ä¸ª</td>
                            <td>æ¯ä¸ªçª—å£ç‹¬ç«‹éœ€è¦ 2-3 ä¸ª buffer</td>
                        </tr>
                    </tbody>
                </table>

                <h3>4. å…³é”®è®¾è®¡å“²å­¦</h3>

                <div class="key-point">
                    <h4>â‘  ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£è€¦</h4>
                    <p><strong>ç”Ÿäº§è€…ï¼ˆAppï¼‰ï¼š</strong> æŒ‰éœ€ç”Ÿäº§ï¼ˆæœ‰è„åŒºåŸŸæ—¶ï¼‰</p>
                    <p><strong>æ¶ˆè´¹è€…ï¼ˆSurfaceFlingerï¼‰ï¼š</strong> æŒç»­æ¶ˆè´¹ï¼ˆæ— è®ºæ–°æ—§å¸§ï¼‰</p>
                    <p>â†’ é™æ€ç•Œé¢å®ç° <strong>é›¶ç»˜åˆ¶ + æŒç»­æ˜¾ç¤º</strong></p>
                </div>

                <div class="key-point">
                    <h4>â‘¡ å…ƒæ•°æ®ä¸åƒç´ åˆ†ç¦»</h4>
                    <p><strong>Binder ä¼ å…ƒæ•°æ®ï¼š</strong> ä½é¢‘ï¼Œ~100B/å¸§ï¼ˆslot ID/æ—¶é—´æˆ³ï¼‰</p>
                    <p><strong>Shared Memory ä¼ åƒç´ ï¼š</strong> é«˜é¢‘ï¼Œ~4MB/å¸§ï¼ˆGraphicBufferï¼‰</p>
                    <p>â†’ æœ€å°åŒ– IPC å¼€é”€</p>
                </div>

                <div class="key-point">
                    <h4>â‘¢ ç¡®å®šæ€§æ—¶åº</h4>
                    <p><strong>VSync å…¨å±€æ—¶é’Ÿï¼š</strong> ç»Ÿä¸€è°ƒåº¦åº”ç”¨ç»˜åˆ¶ä¸ç³»ç»Ÿåˆæˆ</p>
                    <p><strong>Fence ç¡¬ä»¶çº§åŒæ­¥ï¼š</strong> é¿å… GPU/Display è¯»å†™å†²çª</p>
                    <p>â†’ é¿å… jank çš„æ ¹æœ¬ä¿éšœ</p>
                </div>

                <div class="legend">
                    <strong>ğŸ“Œ ç»ˆæè®¤çŸ¥ï¼š</strong> Android å›¾å½¢ç³»ç»Ÿæ˜¯ <strong>ç²¾å¯†çš„å¤šçº§æµæ°´çº¿</strong>ï¼Œç†è§£ <strong>"é™æ€ç•Œé¢é  Buffer Holding
                        æŒç»­æ˜¾ç¤º"</strong> å’Œ <strong>"è„åŒºåŸŸé©±åŠ¨æŒ‰éœ€ç»˜åˆ¶"</strong> æ˜¯æŒæ¡å…¶ä½åŠŸè€—è®¾è®¡çš„æ ¸å¿ƒã€‚æ‰€æœ‰æœºåˆ¶å‡åœ¨ AOSP æºç ä¸­æœ‰æ˜ç¡®å®ç°ï¼Œæ— é»‘ç›’é€»è¾‘ã€‚
                </div>
            </section>
        </div>

        <footer>
            <p>ğŸ“˜ Android é¡µé¢ç»˜åˆ¶å…¨æ™¯è§£æ | åŸºäº AOSP Android 13 æºç </p>
            <p>ğŸ” æ ¸å¿ƒè·¯å¾„ï¼šActivity â†’ Window â†’ DecorView â†’ ViewRootImpl â†’ Surface â†’ BufferQueue â†’ SurfaceFlinger</p>
            <p>ğŸ’¡ ç†è§£ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£è€¦ã€è„åŒºåŸŸé©±åŠ¨ã€Buffer Holding ä¸‰å¤§æœºåˆ¶ï¼ŒæŒæ¡ Android å›¾å½¢ç³»ç»Ÿç²¾é«“</p>
        </footer>
    </div>

    <script>
        // æ·»åŠ é”šç‚¹å¹³æ»‘æ»šåŠ¨
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // æ·»åŠ è¿”å›é¡¶éƒ¨æŒ‰é’®
        window.addEventListener('scroll', function () {
            const scrollTopBtn = document.getElementById('scrollTopBtn');
            if (window.scrollY > 300) {
                if (scrollTopBtn) scrollTopBtn.style.display = 'block';
            } else {
                if (scrollTopBtn) scrollTopBtn.style.display = 'none';
            }
        });
    </script>
</body>

</html>