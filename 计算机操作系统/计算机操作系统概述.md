___
计算机操作系统概述
===
参考资料：计算机操作系统（南京大学：骆斌、葛季栋）MOOC   
2020.08.21  
符燚
***

<!-- TOC -->

- [1. 基础](#1-基础)
    - [1.1. 计算机硬件](#11-计算机硬件)
    - [1.2. 计算机软件](#12-计算机软件)
    - [1.3. 操作系统](#13-操作系统)
    - [1.4. 操作系统的资源](#14-操作系统的资源)
        - [1.4.1. 屏蔽资源使用的底层细节](#141-屏蔽资源使用的底层细节)
        - [1.4.2. 资源共享与分配](#142-资源共享与分配)
        - [1.4.3. 程序控制](#143-程序控制)
        - [1.4.4. 计算机系统操作方式](#144-计算机系统操作方式)
        - [1.4.5. 操作系统的程序接口](#145-操作系统的程序接口)
        - [1.4.6. 操作系统内核](#146-操作系统内核)
- [2. 处理器管理](#2-处理器管理)
    - [2.1. 处理器概述](#21-处理器概述)
        - [2.1.1. 处理器部件](#211-处理器部件)
        - [2.1.2. 指令](#212-指令)
        - [2.1.3. 处理器模式](#213-处理器模式)
    - [2.2. 中断](#22-中断)
        - [2.2.1. 定义](#221-定义)
        - [2.2.2. 中断源](#222-中断源)
        - [2.2.3. 中断系统](#223-中断系统)
        - [2.2.4. 多中断的响应与处理](#224-多中断的响应与处理)

<!-- /TOC -->

# 1. 基础
* 计算机系统组成：硬件子系统、软件子系统
## 1.1. 计算机硬件
* 冯诺依曼计算机模型——存储程序计算机
    >* 以运算单元为中心，控制流由指令流产生
    >* 采用存储程序原理，面向主存组织数据流
    >* 主存是按地址访问、线性编址的空间
    >* 指令由操作码和地址码组成
    >* 数据以二进制编码
* 总线：按照传输的信息种类，包括：一组控制线、一组数据线和一组地址线。按类别还可分为内部总线、系统总线和通信总线。
    >* 内部总线：用于CPU芯片内部连接各元件
    >* 系统总线：用于连接CPU、存储器和各种I/O模块等主要部件
    >* 通信总线：用于计算机系统之间的通信
* 中央处理器（CPU）：是计算机的运算核心（Core）和控制核心（Cintrol Unit），主要包括：
    >* 运算逻辑部件：一个或多个运算器
    >* 寄存器部件：包括通用寄存器、控制与状态寄存器、以及高速缓冲存储器（Cache）
    >* 控制部件：
    >>* 实现各部件间联系的数据、控制及状态的内部总线
    >>* 负责对指令译码、发出为完成每条指令所要执行操作的控制信号、实现数据传输等功能的部件
* 外围设备及其控制
    >* 设备类型：输入设备、输出设备、存储设备、机机通信设备
    >* 设备控制方式：
    >>* 轮询方式：CPU忙式控制，CPU执行内存数据交换
    >>* 中断方式：CPU启动外设，外设中断CPU，CPU执行内存数据交换
    >>* DMA方式：CPU启动DMA，DMA执行输入输出与内存数据交换，DMA中断CPU（Direct Memory Access，直接存储器访问）
## 1.2. 计算机软件
* 三大组成部分：系统软件、支撑软件、应用软件
* 系统软件：操作系统、实用程序、语言处理程序、数据库管理系统
    >* 操作系统实施对各种软硬件资源的管理控制
    >* 实用程序为方便用户所设，如文本编辑等
    >* 语言处理程序把用汇编语言/高级语言编写的程序，翻译成可执行的机器语言程序
* 支撑软件：有接口软件、工具软件、环境数据库、支持用户使用计算机的环境，提供开发工具。也可认为是系统软件的一部分
* 应用软件：使用户按其需要自行编写的专用程序  
## 1.3. 操作系统
* 操作系统（Operating System），简称OS
* 组成：进程调度子系统、进程通信子系统、内存管理子系统、设备管理子系统、文件管理子系统、网络通信子系统、作业控制子系统
* 类型
    > 从操作控制方式  
    >* 多道批处理操作系统，采用脱机控制方式
    >* 分时操作系统，采用交互控制方式
    >* 实时操作系统 
     
    > 从应用领域
    >* 服务器操作系统、并行操作系统
    >* 网络操作系统、分布式操作系统
    >* 个人机操作系统、手机操作系统
    >* 嵌入式操作系统、传感器操作系统
## 1.4. 操作系统的资源
* 处理器资源、内存资源、设备资源、信息资源管理、信号量资源
### 1.4.1. 屏蔽资源使用的底层细节
* 驱动程序：最底层的、直接控制和监视各类硬件（或文件）资源的部分
* 职责是隐藏底层硬件的具体细节、并向其他部分提供一个抽象的、通用的接口
### 1.4.2. 资源共享与分配
* 资源共享方式
    >* 独占使用方式
    >* 并发使用方式
* 资源分配策略
    >* 静态分配方式
    >* 动态分配方式
    >* 资源独占方式
### 1.4.3. 程序控制
* 多道程序同时计算。CPU速度与I/O速度不匹配的矛盾。只有让多道程序同时进入内存争抢CPU运行，才可以使得CPU和外围设备充分并行，从而提高计算机系统的使用效率
* 多道程序设计：指让多个程序同时进入计算机的主存储器进行计算
* 多道程序设计的特点
    >* CPU与外围设备充分并行
    >* 外围设备之间充分并行
    >* 发挥CPU的使用效率
    >* 提高单位时间的算题量
* 进程：为进入内存执行的程序建立的管理实体
* OS能管理与控制进程程序的执行
* OS协调管理各类资源在进程间的使用
    >* 处理器的管理与调度
    >* 主存储器的管理和调度
    >* 其他资源的管理和调度
### 1.4.4. 计算机系统操作方式
* OS规定了合理操作计算机的工作流程
* OS的操作接口——系统程序  
OS提供给用户的功能级接口，为用户提供的解决操作计算机和计算共性问题的所有服务的集合
* 作业，是用户在一次计算过程中或者事务处理过程中，要求计算机所作工作的集合。
* 作业是不同相接的顺序步组成，这些作业步之间总是相互在时间和所占空间方面关联的。
* OS的两类作业级接口：
    >* 脱机作业控制方式：作业控制语句
    >* 联机作业控制方式：操作控制命令
* 脱机作业控制方式：
    >* OS：提供作业说明语言
    >* 用户：编写作业说明书，确定作业加工步骤，并与程序数据一并提交
    >* 操作员：通过控制台输入**作业**
    >* OS：通过作业控制程序自动控制作业的执行
    >* 例如：批处理OS的作业控制方式：UNIX的Shell程序、DOS的bat文件
* 联机作业控制方式
    >* 计算机：提供终端（键盘/显示器）
    >* 用户：登录系统
    >* 用户：联机输入命令，直接控制**作业步**的执行
    >* 例如：分时OS的交互控制方式
* 命令解释程序：接受和执行一条用户提出的对作业的加工处理命令
* 当一个新的批作业被启动，或新的交互型用户登录进系统时，系统就自动的执行命令解释程序，负责读入控制卡或命令行，做出相应的解释，并予以执行
* 命令解释程序的分类
    >* 会话语言：可编程的命令解释程序
    >* 图形化的命令控制方式
    >* 多通道交互的命令控制方式
* 命令解释程序的处理过程
    >* OS启动命令解释程序，输出命令提示符，等待键盘中断/鼠标点击/多通道识别
    >* 每当用户输入一条命令（暂存在命令缓冲区），并按回车换行时，申请中断
    >* CPU响应后，将控制权交给命令解释程序，接着读入命令缓冲区内容，分析命令、接收参数，执行处理代码
* 前台命令和后台命令
    >* 前台命令执行结束后，再次输出命令提示符，等待下一条命令
    >* 后台命令处理启动后，即可接收下条命令
### 1.4.5. 操作系统的程序接口
* 操作系统的程序接口——系统调用
* 操作系统提供的完成某种特定功能的过程。为所有运行程序提供访问操作系统的接口
* 系统调用的实现机制
    >* 陷入处理机制：计算机系统中控制和实现系统调用的机制
    >* 陷入指令：也称访管指令，或异常中断指令，计算机系统为实现系统调用而引起处理器中断的指令
    >* 每个系统调用都事先规定了编号，并在约定寄存器中规定了传递给内部处理程序的参数
    >* 编写系统调用处理程序
    >* 设计一张系统调用入口地址表，每个入口地址指向一个系统调用的处理程序，并包含系统调用自带参数的个数
    >* 陷入处理机制需开辟现场保护区，以保存发生系统调用时的处理器现场
### 1.4.6. 操作系统内核
* 单内核：内核中各部件杂然混居的形态。如Unix/Linux，及Windows（自称采用混合内核的CS结构）
* 微内核：强调结构性部件与功能性部件的分离
* 混合内核：微内核和单内核的折中，较多组件在核心态中运行
* 外内核：尽可能减少内核的软件抽象化和传统微内核的消息传递机制，使得开发者专注于硬件的抽象化；部分嵌入式系统使用

# 2. 处理器管理
## 2.1. 处理器概述
### 2.1.1. 处理器部件
* 处理器部件
![处理器部件示意图](处理器部件示意图.png)
* 用户程序可见寄存器：可以使程序员减少访问主存储器的次数，提高指令执行的效率。所有程序可用，包括应用程序和系统程序
    * 数据寄存器：又称通用寄存器。AX、BX、CX、DX
    * 地址寄存器：索引（SI、DI）、栈指针（SP、BP）、段地址等寄存器（CS、DS、SS、ES）
* 控制与状态寄存器：用于控制处理器的操作。主要被具有特权的操作系统程序使用，以控制程序的执行
    * 程序计数器PC：存储将取指令的地址
    * 指令寄存器IR：存储最近使用的指令
    * 条件码CC：CPU为指令操作结果设置的位，标志正/负/零/溢出等结果
    * 标志位：中断位、中断允许位、中断屏蔽位、处理器模式位、内存保护位……
* 程序状态字PSW
    * 既是操作系统的概念，指记录当前程序运行状态的动态信息，通常包括
        * 程序计数器、指令寄存器、条件码
        * 中断字、中断允许/禁止、中断屏蔽、处理器模式、内存保护、调试控制
    * 也是计算机系统的寄存器，通常设置一组控制与状态寄存器，也可专设一个PSW寄存器
### 2.1.2. 指令
* 机器指令：是计算机系统执行的基本命令，是中央处理器执行的基本单位。由一个或多个字节组成，包括操作码字段、一个或多个操作数地址字段、以及一些表征机器状态的状态字以及特征码。指令完成各种算术逻辑运算、数据传输、控制流跳转特征码
* 机器指令执行过程
    * CPU根据PC取出指令，放入IR，并对指令译码，然后发出各种控制命令，执行微操作系列，从而完成一条指令的执行，设置CC位与PC值
    * 指令执行周期：取指+解码+执行
    * 一般通过指令流水线方式执行。把指令过程分解为若干子过程，每个子过程都可有效的在其专用功能段上与其他子过程重叠执行
* 特权指令与非特权指令：用户程序并非能够使用全部机器指令，哪些与计算机核心资源相关的特殊指令会被保护。如启动I/O指令、置PC指令
    * 特权指令：只能被操作系统内核使用的指令
    * 非特权指令：能够被所有程序使用的指令
    * 特权指令与非特权指令通过处理器模式位区分
### 2.1.3. 处理器模式
* 处理器模式：计算机通过设置处理器模式实现特权指令管理
    * 计算机一般设置0、1、2、3等四种运行模式：0操作系统内核，1系统调用，2共享库程序，3用户程序保护等保护级别
    * 0模式可以执行全部指令，3模式只能执行非特权指令，其它每种运行模式可以规定执行的指令子集
    * 一般来说，现代操作系统只使用0和3两种模式，对应于内核模式和用户模式
* 模式的切换
    * 包括“用户模式->内核模式”和“内核模式->用户模式”的转换
    * 中断、异常或系统异常等事件导致用户程序向OS内核切换，触发“用户模式->内核模式”
        * 程序运行时发生并响应中断
        * 程序运行时发生异常
        * 程序请求操作系统服务
    * OS内核处理完成后，调用中断返回指令（如Intel的iret）触发“内核模式->用户模式”
## 2.2. 中断
### 2.2.1. 定义
* 中断：指程序执行过程中，遇到急需处理的事件时，暂时中止CPU上现行程序的运行，转去执行相应的事件处理程序，待处理完成后再返回原程序被中断处或调度其它程序执行的过程
* **操作系统是“中断驱动的”**。即中断是激活操作系统的唯一方式。（广义上的中断）
* 狭义的中断：指来源于处理器之外的中断事件，即与当前运行指令无关的中断事件，如I/O中断、时钟中断、外部信号中断等
* 异常：指当前运行指令引起的中断事件（来源于CPU内部），如地址异常、算数异常、处理器硬件故障等
* 系统异常：指执行陷入指令而触发系统调用引起的中断事件，如请求设备、请求I/O、创建进程等。可以视为异常中的一类
### 2.2.2. 中断源
* 处理器硬件故障中断事件--异常
    * 由处理器、内存储器、总线等硬件故障引起
    * 处理原则：保护现场，停止设备，停止CPU，向操作员报告，等待人工干预。（电路中存在电容）
* 程序性中断事件：处理器执行机器指令引起的--异常
    * 除数为零、操作数溢出等算数异常。处理：简单处理，报告用户；也可以由用户编写中断续元程序处理
    * 非法指令、用户态使用特权指令、地址越界、非法存取等指令异常。处理：中止进程
    * 终止进程指令。处理：终止进程
    * 虚拟地址异常。处理：调整内存后重新加载执行指令。该异常比较特殊，该指令没有执行完，其它中断都是执行完当前指令，所以该种异常需要重新加载执行指令
* 自愿性中断事件--系统异常
    * 处理器执行陷入指令请求OS服务引起。在操作系统中，又称为系统调用
    * 如请求分配外设、请求I/O等
    * 处理流程：陷入OS，保护现场，根据功能号查入口地址，跳转具体处理程序
* I/O中断事件：来源于外围设备报告I/O状态的中断事件--狭义的中断事件
    * I/O完成：调整进程状态，释放等待进程等
    * I/O出错：等待人工干预
    * I/O异常：等待人工干预
* 外部中断事件：由外围设备发出的信号引起的中断事件
    * 时钟中断、间隔时钟中断：计时与时间片处理
    * 设备报道与结束中断：调整设备表
    * 键盘/鼠标信号中断：根据信号做出相应反应
    * 关机/重启动中断：写回文件，停止设备与CPU
### 2.2.3. 中断系统
* 中断系统是计算机系统中响应和处理中断的系统，包括硬件子系统和软件子系统两部分
* 中断响应由硬件子系统完成
* 中断处理由软件子系统完成
* 在指令执行周期最后增加一个微操作，以响应中断
![中断响应与指令执行周期](中断响应与指令执行周期.png)
* 中断装置
    * 计算机系统中发现并响应中断/异常的硬件装置
    * 由于中断源的多样性，硬件实现的中断装置有多种，分别处理不同类型的中断。因计算机而异，通常有：
        * 处理器外的中断：由中断控制器发现和响应
        * 处理器内的异常：由指令的控制逻辑和实现线路发现和响应，相应机制称为陷阱
        * 请求OS服务的系统异常：处理器执行陷入指令时直接触发，相应机制称为系统陷阱
    * 中断控制器：CPU中的一个控制部件，包括中断控制逻辑线路（形成中断的通路）和中断寄存器（记录是哪个中断）
        * 外部设备向其发出中断请求IRQ，在中断寄存器中设置已发生的中断
        * 指令处理结束前，会检查中断寄存器，若有不被屏蔽的中断产生，则改变处理器内操作的顺序，引出操作系统中的中断处理程序
    * 陷阱和系统陷阱：指令的逻辑实现线路的一部分
        * 执行指令出现异常后，会根据异常情况转向操作系统的异常处理程序
        * 出现虚拟地址异常后，需要重新执行指令，往往越过陷阱独立设置页面异常处理程序
        * 执行陷入指令后，越过陷阱处理，触发系统陷阱，激活系统调用处理程序
* 中断响应过程
    1. 发现中断源，提出中断请求
        * 发现中断寄存器中记录的中断
        * 决定这些中断是否被屏蔽
        * 当有多个要响应的中断源时，根据规定的优先级选择一个
    2. 中断当前程序的执行
        * 保存当前程序的PSW/PC到核心栈
    3. 转向操作系统的中断处理程序
* 中断的处理
    * 中断处理程序：操作系统处理中断事件的控制程序，主要任务是处理中断事件和恢复正常工作
        * 保护未被硬件保护的处理器状态
        * 通过分析被中断程序的PSW中断码字段，识别中断源
        * 分别处理发生的中断事件
        * 恢复正常的操作
    * 恢复正常操作
        * 对于某些中断，在处理完毕后，直接返回刚刚被中断的进程
        * 对于其它一些中断，要中断当前进程的运行，调整进程队列，启动进程调度，选择下一个执行的进程并恢复其执行。如输入输出
* 中断系统处理流程
![中断系统处理流程](中断系统处理流程.png)
### 2.2.4. 多中断的响应与处理
* 中断屏蔽：当计算机系统检测到中断时，中断装置通过中断屏蔽位决定是否响应已发生的中断，有选择的响应中断
* 中断优先级
    * 当计算机同时检测到多个中断时，中断装置响应中断的顺序
    * 有优先度的响应中断
    * 一种可能的处理次序：
        1. 处理机硬件故障中断事件
        2. 自愿性中断事件
        3. 程序性中断事件
        4. 时钟中断等外部中断事件
        5. 输入输出中断事件
        6. 重启动和关机中断事件
    * 不同类型的操作系统有不同的中断优先级
* 中断的嵌套处理
    * 当计算机响应中断后，在中断处理过程中，可以再响应其它中断
    * 操作系统是性能攸关程序，且中断响应处理有硬件要求，考虑系统效率和实现代价问题，中断的嵌套处理应限制在一定层数内，如3层
    * 中断的嵌套处理改变中断处理次序，先响应的有可能后处理
* 决定中断处理次序的因素
    * 中断屏蔽可以使中断装置不响应某些中断
    * 中断优先级决定了中断装置响应中断的次序
    * 中断的嵌套处理改变中断处理次序